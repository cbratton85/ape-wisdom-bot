name: Hourly Email Scan

on:
  schedule:
    # Runs at minute 0, past hour 13 through 21 (1 PM to 9 PM UTC), Mon-Fri
    - cron: '0 13-21 * * 1-5'
  workflow_dispatch:      # Allows manual testing

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # --- NEW STEP: Restore & Save Cache ---
      - name: Cache JSON Data
        uses: actions/cache@v3
        with:
          path: ape_cache.json
          # We use run_id to ensure we always save a NEW cache at the end
          key: ape-cache-${{ github.run_id }}
          # This tells it to look for ANY previous cache starting with "ape-cache-"
          restore-keys: |
            ape-cache-

      - name: Install dependencies
        run: |
          pip install pandas yfinance requests lxml

      - name: Run Script
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: python ape_wisdom.py --auto
